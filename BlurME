#!/bin/sh
# BlurME is dedicated to You!
while getopts ":w:b:c:o:" opt
do
  case "$opt" in
    w ) wid=$OPTARG;;
    b ) blur=$OPTARG;;
    c ) wp=$OPTARG;;
    o ) output=$OPTARG;;
  esac
done
KDEB () {
    dbus-send --session --dest=org.kde.plasmashell --type=method_call /PlasmaShell org.kde.PlasmaShell.evaluateScript 'string:var Desktops = desktops();for (i=0;i<Desktops.length;i++) {d = Desktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper","org.kde.image","General");d.writeConfig("Image", "file:///'$wp_blur'");}'
}
KDEW () {
    dbus-send --session --dest=org.kde.plasmashell --type=method_call /PlasmaShell org.kde.PlasmaShell.evaluateScript 'string:var Desktops = desktops();for (i=0;i<Desktops.length;i++) {d = Desktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper","org.kde.image","General");d.writeConfig("Image", "file://'$wp'");}'
}
trap 'echo "SIGINT caught!"; KDEW; exit 1' INT TERM

while sleep 1
do
echo "$wp_blur"
echo 'Bluring with scale of '"$blur"
if [ -z "$wp" ]; then
    echo "No wallpaper set"
    echo "Use '-c'"
    exit 1
else
    echo 'Wallpaper is '"$wp"
fi
if [ -n "$output" ]; then
    echo 'saving to '"$output"
fi

echo 'Blurring with scale of '"$blur"
if [ "$blur" -ge "2" ]; then
    echo 'Blurring, image with scale of '"$blur"
    convert "$wp" -blur 0x"$blur" "$output"/output.png
    echo "Blurred!"
else
    echo "'-b' not used!?"
    echo "Segmeant Fault"
    exit 1
fi
if [ "$XDG_CURRENT_DESKTOP" = "KDE" ]; then
    lswK=$(lsw | wc -l)
    echo "$lswK Windows/Widgets Are Open"
    if [ -n "$wid" ]; then
        echo "Widget Amount is $wid"
    else
        wid="2"
    fi
if [ "$lswK" -le "$wid" ]; then
    echo "Setting Non-Blurred Wallpaper"
    KDEW
else
    if [ "$lswK" = "1" ]; then
        echo "Setting Non-Blurred Wallpaper"
        KDEW
    else
      echo "Blurring"
      echo "$PWD"
      echo "$wp_blur"
      KDEB
    fi
  fi
else
  if [ "$DESKTOP_SESSION" = "/usr/share/xsessions/plasma" ]; then
    lswK=$(lsw | wc -l)
    if [ -n "$wid" ]; then
      echo "Widget Amount is $wid"
    else 
      wid="2"
    fi
    if [ "$lswK" -le "$wid" ]; then
      echo "Setting Non-Blurred Wallpaper"
      KDEW
    else
      if [ "$lswK" = "1" ]; then
        echo "Setting Non-Blurred Wallpaper"
        KDEW
      else 
        echo "Blurring"
        KDEB
        echo "Blurred"
      fi
    fi
  else
    while sleep 1
    lswK=$(lsw | wc -l)
    do
        if [ "$lswK" -le "$wid" ];
        then
            echo "$lswK Windows are open"
            echo "Max number of windows is $wid"
            echo "Setting no blured wallpaper"
            feh --bg-fill "$wp"
        else
            echo "Max window number is $wid"
            echo "current is $lswK"
            echo "Bluring"
            feh --bg-fill "$wp_blur"
        fi
    done
  fi
fi
done
