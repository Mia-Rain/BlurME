#!/bin/sh
wp_blur="<>"
wp="<>"
while getopts ":w:" c
do
  case "$c" in
    w) wid=$OPTARG ;;
  esac 
done
while sleep 1
do 
if [ $XDG_CURRENT_DESKTOP = "KDE" ]; then
  lswK=$(lsw | wc -l)
  echo $lswK Windows/Widgets Are Open
  if [ -n "$wid" ]; then
    echo "Widget Amount is $wid"
  else
    wid="2"
  fi
  if [ "$lswK" -le "$wid" ]; then
    echo "Setting Non-Blurred Wallpaper"
    qdbus org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript 'var allDesktops = desktops();print (allDesktops);for (i=0;i<allDesktops.length;i++) {d = allDesktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper", "org.kde.image", "General");d.writeConfig("Image", "file:///<wp>")}'
  else
    if [ "$lswK" = "1" ]; then
      echo "Setting Non-Blurred Wallpaper"
      qdbus org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript 'var allDesktops = desktops();print (allDesktops);for (i=0;i<allDesktops.length;i++) {d = allDesktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper", "org.kde.image", "General");d.writeConfig("Image", "file:///<wp>")}'
    else 
      echo "Setting Blurred Wallpaper"
      qdbus org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript 'var allDesktops = desktops();print (allDesktops);for (i=0;i<allDesktops.length;i++) {d = allDesktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper", "org.kde.image", "General");d.writeConfig("Image", "file:///<wp_blur>")}'
    fi
  fi
else
  if [ $DESKTOP_SESSION = "/usr/share/xsessions/plasma" ]; then
    lswK=$(lsw | wc -l)
    if [ -n "$wid" ]; then
      echo "Widget Amount is $wid"
    else 
      wid="2"
    fi
    if [ "$lswK" -le "$wid" ]; then
      echo "Setting Non-Blurred Wallpaper"
      qdbus org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript 'var allDesktops = desktops();print (allDesktops);for (i=0;i<allDesktops.length;i++) {d = allDesktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper", "org.kde.image", "General");d.writeConfig("Image", "file:///<wp>")}'
    else
      if [ "$lswK" = "1" ]; then
        echo "Setting Non-Blurred Wallpaper"
        qdbus org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript 'var allDesktops = desktops();print (allDesktops);for (i=0;i<allDesktops.length;i++) {d = allDesktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper", "org.kde.image", "General");d.writeConfig("Image", "file:///<wp_blur>")}'
      else 
        echo "Setting Blurred Wallpaper"
        qdbus org.kde.plasmashell /PlasmaShell org.kde.PlasmaShell.evaluateScript 'var allDesktops = desktops();print (allDesktops);for (i=0;i<allDesktops.length;i++) {d = allDesktops[i];d.wallpaperPlugin = "org.kde.image";d.currentConfigGroup = Array("Wallpaper", "org.kde.image", "General");d.writeConfig("Image", "file:///<wp>")}'
      fi
    fi
  else
    wp="<>"
    wp_blurred="<>"
    while sleep 1
    do 
    if [ -z "$(lsw)" ]
      then 
        feh --bg-fill --no-fehbg "<$wp_blurred>"
      else 
        feh --bg-fill --no-fehbg "<$wp>"
    fi 
  done
  fi
fi 
done
